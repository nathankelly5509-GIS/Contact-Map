<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Contact Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height:100vh; display:flex; flex-direction:column; }
    #header { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:1rem; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    #header h1 { font-size:1.5rem; margin-bottom:.5rem; }
    .controls { display:flex; gap:1rem; flex-wrap:wrap; align-items:center; }
    .control-group { display:flex; flex-direction:column; gap:.25rem; }
    .control-group label { font-size:.85rem; opacity:.9; }
    input,select { padding:.5rem; border:none; border-radius:4px; font-size:.95rem; }
    #nameSearch{ width:220px; }
    #stateSelect,#countySelect,#typeFilter{ width:180px; }
    button { padding:.5rem 1rem; background:#fff; color:#667eea; border:none; border-radius:4px; cursor:pointer; font-weight:600; transition:transform .2s; }
    button:hover{ transform:translateY(-2px); box-shadow:0 2px 8px rgba(0,0,0,.2); }
    #map{ flex:1; width:100%; position:relative; }
    #resultCount{ position:absolute; top:80px; left:10px; background:#fff; padding:8px 12px; border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,.1); z-index:1000; font-size:.9rem; }
    .legend{ position:absolute; bottom:30px; right:10px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.2); z-index:1000; max-height:300px; overflow-y:auto; }
    .legend h3{ margin-bottom:10px; color:#333; font-size:1rem; }
    .legend-item{ display:flex; align-items:center; margin-bottom:8px; cursor:pointer; padding:4px; border-radius:4px; transition:background .2s; }
    .legend-item:hover{ background:#f0f0f0; }
    .legend-item input[type="checkbox"]{ margin-right:8px; }
    .legend-color{ width:20px; height:20px; border-radius:50%; margin-right:8px; border:2px solid #fff; box-shadow:0 1px 3px rgba(0,0,0,.3); }
    .info-popup{ max-width:260px; }
    .info-popup h4{ margin-bottom:8px; color:#667eea; }
    .info-popup p{ margin:4px 0; font-size:.9rem; }
    .info-popup a{ color:#667eea; text-decoration:none; }
    .info-popup a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div id="header">
    <h1>üìç Interactive Contact Map</h1>
    <div class="controls">
      <div class="control-group">
        <label for="nameSearch">Search by Full Name:</label>
        <input type="text" id="nameSearch" placeholder="Type full or last name...">
      </div>
      <div class="control-group">
        <label for="stateSelect">Filter by State:</label>
        <select id="stateSelect"><option value="">All States</option></select>
      </div>
      <div class="control-group">
        <label for="countySelect">Filter by County:</label>
        <select id="countySelect"><option value="">All Counties</option></select>
      </div>
      <div class="control-group">
        <label for="typeFilter">Filter by Type:</label>
        <select id="typeFilter">
          <option value="">All Types</option>
          <option value="Broker">Broker</option>
          <option value="Surveyor">Surveyor</option>
          <option value="Clearing/Graded">Clearing/Graded</option>
          <option value="Soil Scientist">Soil Scientist</option>
        </select>
      </div>
      <button id="btnClear">Clear Filters</button>
      <button id="btnFit">Zoom to Fit</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="resultCount"></div>
  <div class="legend">
    <h3>Contact Types</h3>
    <div id="legendContent"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const EMBEDDED_FEATURES = [];

    const TYPE_COLORS = {"Broker": "#FF6B6B", "Surveyor": "#4ECDC4", "Clearing/Graded": "#45B7D1", "Soil Scientist": "#FFEAA7"};

    const map = L.map('map').setView([39.8283, -98.5795], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap contributors' }).addTo(map);
    const markerCluster = L.markerClusterGroup({
      chunkedLoading:true,
      maxClusterRadius:50,
      spiderfyOnMaxZoom:true,
      showCoverageOnHover:false,
      disableClusteringAtZoom:10
    }).addTo(map);

    let allMarkers = [];
    let contactsData = EMBEDDED_FEATURES.filter(f => ["Broker","Surveyor","Clearing/Graded","Soil Scientist"].includes(f.properties.Contact_Type));

    function createCustomMarker(feature){
      const color = TYPE_COLORS[feature.properties.Contact_Type] || '#808080';
      const html = `<div style="background-color:${color};width:24px;height:24px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.3);"></div>`;
      return L.divIcon({ html, className:'custom-marker', iconSize:[24,24], iconAnchor:[12,12], popupAnchor:[0,-12] });
    }

    function safeJoin(a,b){ return [a,b].filter(Boolean).join(', '); }

    function createPopupContent(p){
      let html = `<div class="info-popup">`;
      html += `<h4>${p.Full_Name || 'Unknown'}</h4>`;
      if (p.Contact_Type) html += `<p><strong>Type:</strong> ${p.Contact_Type}</p>`;
      if (p.Company) html += `<p><strong>Company:</strong> ${p.Company}</p>`;
      if (p.Job_Title) html += `<p><strong>Title:</strong> ${p.Job_Title}</p>`;
      if (p.Phone) html += `<p><strong>Phone:</strong> ${p.Phone}</p>`;
      if (p.Email) html += `<p><strong>Email:</strong> <a href="mailto:${p.Email}">${p.Email}</a></p>`;
      if (p.Website){
        const url = p.Website.startsWith('http') ? p.Website : `http://${p.Website}`;
        html += `<p><strong>Website:</strong> <a href="${url}" target="_blank" rel="noopener">${p.Website}</a></p>`;
      }
      const addr = safeJoin(p.Address, p.City);
      if (addr) html += `<p><strong>Address:</strong> ${addr}</p>`;
      if (p.County || p.State) html += `<p><strong>Location:</strong> ${safeJoin(p.County, p.State)}</p>`;
      if (p.Counties_Service) html += `<p><strong>Service Area:</strong> ${p.Counties_Service}</p>`;
      if (p.Notes) html += `<p><strong>Notes:</strong> ${p.Notes}</p>`;
      html += `</div>`;
      return html;
    }

    function updateLegend(){
      const LEG_ORDER = ["Broker","Surveyor","Clearing/Graded","Soil Scientist"];
      const counts = Object.fromEntries(LEG_ORDER.map(t => [t,0]));
      contactsData.forEach(f => { counts[f.properties.Contact_Type] = (counts[f.properties.Contact_Type]||0)+1; });
      const wrap = document.getElementById('legendContent');
      wrap.innerHTML = '';
      LEG_ORDER.forEach(type => {
        const color = TYPE_COLORS[type] || '#808080';
        const safeId = `type_${type.replace(/[^\w]/g,'_')}`;
        const div = document.createElement('div');
        div.className = 'legend-item';
        div.innerHTML = `
          <input type="checkbox" id="${safeId}" data-type="${type}" checked>
          <div class="legend-color" style="background-color:${color}"></div>
          <label for="${safeId}">${type} (${counts[type]||0})</label>
        `;
        wrap.appendChild(div);
      });
      wrap.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', updateMarkers));
    }

    function populateFilters(){
      const stateSel = document.getElementById('stateSelect');
      const countySel = document.getElementById('countySelect');

      const states = new Set();
      const counties = new Set();
      contactsData.forEach(f => { const p = f.properties; if (p.State) states.add(p.State); if (p.County) counties.add(p.County); });

      stateSel.innerHTML = '<option value="">All States</option>' + Array.from(states).sort().map(s => `<option value="${s}">${s}</option>`).join('');
      countySel.innerHTML = '<option value="">All Counties</option>' + Array.from(counties).sort().map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function getLegendAllowlist(){
      const allow = new Set();
      document.querySelectorAll('#legendContent input[type="checkbox"]').forEach(cb => { if (cb.checked) allow.add(cb.dataset.type); });
      return allow;
    }

    function updateMarkers(){
      markerCluster.clearLayers();
      allMarkers = [];

      const nameSearch = (document.getElementById('nameSearch').value || '').toLowerCase().trim();
      const stateFilter = document.getElementById('stateSelect').value;
      const countyFilter = document.getElementById('countySelect').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const allowLegend = getLegendAllowlist();

      let visibleCount = 0;

      EMBEDDED_FEATURES.forEach(f => {
        const p = f.properties;
        if (!["Broker","Surveyor","Clearing/Graded","Soil Scientist"].includes(p.Contact_Type)) return;
        if (!allowLegend.has(p.Contact_Type)) return;
        if (nameSearch && !(p.Full_Name||'').toLowerCase().includes(nameSearch)) return;
        if (stateFilter && p.State !== stateFilter) return;
        if (countyFilter && p.County !== countyFilter) return;
        if (typeFilter && p.Contact_Type !== typeFilter) return;

        const [lng, lat] = f.geometry.coordinates;
        const marker = L.marker([lat, lng], { icon: createCustomMarker(f) });
        marker.bindPopup(createPopupContent(p));
        allMarkers.push(marker);
        visibleCount++;
      });

      markerCluster.addLayers(allMarkers);
      document.getElementById('resultCount').textContent = `Showing ${visibleCount} of ${contactsData.length} contacts`;
    }

    function zoomToFit(){
      if (allMarkers.length){
        const group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }

    // Linkage: when State changes, repopulate counties by filtered state
    document.getElementById('stateSelect').addEventListener('change', () => {
      const sel = document.getElementById('stateSelect').value;
      const counties = new Set();
      EMBEDDED_FEATURES.forEach(f => { const p = f.properties; if (sel ? p.State === sel : true) { if (p.County) counties.add(p.County); } });
      const countySel = document.getElementById('countySelect');
      countySel.innerHTML = '<option value="">All Counties</option>' + Array.from(counties).sort().map(c => `<option value="${c}">${c}</option>`).join('');
      updateMarkers();
    });

    document.getElementById('countySelect').addEventListener('change', updateMarkers);
    document.getElementById('typeFilter').addEventListener('change', updateMarkers);
    document.getElementById('nameSearch').addEventListener('input', updateMarkers);
    document.getElementById('btnClear').addEventListener('click', () => {
      document.getElementById('nameSearch').value = '';
      document.getElementById('stateSelect').value = '';
      document.getElementById('countySelect').value = '';
      document.getElementById('typeFilter').value = '';
      document.querySelectorAll('#legendContent input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateMarkers();
      setTimeout(zoomToFit, 100);
    });
    document.getElementById('btnFit').addEventListener('click', zoomToFit);

    updateLegend();
    populateFilters();
    updateMarkers();
    setTimeout(zoomToFit, 200);
  </script>
</body>
</html>
