<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Contact Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height:100vh; display:flex; flex-direction:column; }
    #header { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:1rem; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    #header h1 { font-size:1.5rem; margin-bottom:.5rem; }
    .controls { display:flex; gap:1rem; flex-wrap:wrap; align-items:center; }
    .control-group { display:flex; flex-direction:column; gap:.25rem; }
    .control-group label { font-size:.85rem; opacity:.9; }
    input,select { padding:.5rem; border:none; border-radius:4px; font-size:.95rem; }
    #nameSearch{ width:200px; } #countySelect,#typeFilter{ width:180px; }
    button { padding:.5rem 1rem; background:#fff; color:#667eea; border:none; border-radius:4px; cursor:pointer; font-weight:600; transition:transform .2s; }
    button:hover{ transform:translateY(-2px); box-shadow:0 2px 8px rgba(0,0,0,.2); }
    #map{ flex:1; width:100%; position:relative; }
    .loading-overlay{ position:absolute; inset:0; background:rgba(255,255,255,.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:10000; }
    .loading-spinner{ border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .loading-text{ margin-top:20px; color:#667eea; font-size:1.1rem; }
    .legend{ position:absolute; bottom:30px; right:10px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.2); z-index:1000; max-height:300px; overflow-y:auto; }
    .legend h3{ margin-bottom:10px; color:#333; font-size:1rem; }
    .legend-item{ display:flex; align-items:center; margin-bottom:8px; cursor:pointer; padding:4px; border-radius:4px; transition:background .2s; }
    .legend-item:hover{ background:#f0f0f0; }
    .legend-item input[type="checkbox"]{ margin-right:8px; }
    .legend-color{ width:20px; height:20px; border-radius:50%; margin-right:8px; border:2px solid #fff; box-shadow:0 1px 3px rgba(0,0,0,.3); }
    .info-popup{ max-width:260px; }
    .info-popup h4{ margin-bottom:8px; color:#667eea; }
    .info-popup p{ margin:4px 0; font-size:.9rem; }
    .info-popup a{ color:#667eea; text-decoration:none; }
    .info-popup a:hover{ text-decoration:underline; }
    #resultCount{ position:absolute; top:80px; left:10px; background:#fff; padding:8px 12px; border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,.1); z-index:1000; font-size:.9rem; }
    .file-upload-container{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:30px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.2); z-index:10000; max-width:600px; display:block; }
    .file-upload-container h3{ color:#667eea; margin-bottom:20px; }
    .file-upload-container p{ margin-bottom:15px; line-height:1.5; }
    .file-input-section{ margin-top:20px; padding-top:20px; border-top:2px solid #eee; }
    .file-input-group{ margin-bottom:15px; }
    .file-input-group label{ display:block; margin-bottom:5px; font-weight:600; color:#333; }
    .file-input-group input[type="file"]{ width:100%; padding:8px; border:2px dashed #667eea; border-radius:4px; background:#f8f9fa; }
    .file-list{ margin-top:10px; padding:10px; background:#f8f9fa; border-radius:4px; font-size:.9rem; display:none; }
    .file-list-item{ margin:5px 0; color:#666; }
    #loadLocalFiles{ width:100%; margin-top:15px; padding:12px; background:#667eea; color:#fff; }
    .stats-panel{ position:absolute; top:120px; left:10px; background:#fff; padding:12px; border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,.1); z-index:1000; font-size:.85rem; max-width:200px; display:none; }
    .stats-panel h4{ margin-bottom:8px; color:#667eea; }
    .leaflet-control-attribution{ font-size:10px !important; }
  </style>
</head>
<body>
  <div id="header">
    <h1>üìç Interactive Contact Map</h1>
    <div class="controls">
      <div class="control-group">
        <label for="nameSearch">Search by Name:</label>
        <input type="text" id="nameSearch" placeholder="Enter name...">
      </div>
      <div class="control-group">
        <label for="countySelect">Filter by County:</label>
        <select id="countySelect"><option value="">All Counties</option></select>
      </div>
      <div class="control-group">
        <label for="typeFilter">Filter by Type:</label>
        <select id="typeFilter"><option value="">All Types</option></select>
      </div>
      <button id="btnClear">Clear Filters</button>
      <button id="btnFit">Zoom to Fit</button>
    </div>
  </div>

  <div id="map">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading...</div>
    </div>
    <div class="file-upload-container" id="fileUploadContainer">
      <h3>Load Your Contact Data</h3>
      <p>Select your CSV files to display contacts on the map. You can select multiple contact files at once.</p>
      <div class="file-input-section">
        <div class="file-input-group">
          <label for="contactsFile">Select Contact CSV files:</label>
          <input type="file" id="contactsFile" accept=".csv" multiple>
          <small>Select all your contact CSV files (Brokers, Surveyors, etc.)</small>
        </div>
        <div class="file-input-group">
          <label for="countiesFile">Select Counties CSV file (optional):</label>
          <input type="file" id="countiesFile" accept=".csv">
          <small>Counties file for boundary display</small>
        </div>
        <div id="fileList" class="file-list">
          <strong>Selected files:</strong>
          <div id="fileListContent"></div>
        </div>
        <button id="loadLocalFiles">Load Files and Create Map</button>
      </div>
    </div>
  </div>

  <div id="resultCount"></div>
  <div class="stats-panel" id="statsPanel">
    <h4>Contact Types</h4>
    <div id="statsContent"></div>
  </div>
  <div class="legend">
    <h3>Contact Types</h3>
    <div id="legendContent"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // ==================== MAP INIT ====================
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap contributors' }).addTo(map);

    const markerCluster = L.markerClusterGroup({
      chunkedLoading:true,
      maxClusterRadius:50,
      spiderfyOnMaxZoom:true,
      showCoverageOnHover:false,
      disableClusteringAtZoom:10
    }).addTo(map);

    const typeColors = {
      'Brokers':'#FF6B6B',
      'Surveyors':'#4ECDC4',
      'Cleared/Graded':'#45B7D1',
      'Clearers/Graders':'#45B7D1',
      'Contractors':'#96CEB4',
      'Soil Scientists':'#FFEAA7',
      'Soil_Scientists':'#FFEAA7'
    };

    let allMarkers = [];
    let contactsData = [];
    let visibleTypes = new Set();
    let typeStats = {};

    // ==================== FILE UI ====================
    const contactsInput = document.getElementById('contactsFile');
    const countiesInput  = document.getElementById('countiesFile');
    const fileList = document.getElementById('fileList');
    const fileListContent = document.getElementById('fileListContent');

    contactsInput.addEventListener('change', updateFileList);
    countiesInput.addEventListener('change', updateFileList);

    function updateFileList(){
      const contactFiles = contactsInput.files;
      const countyFile = countiesInput.files[0];
      let html = "";
      if (contactFiles.length > 0){
        html += '<div class="file-list-item"><strong>Contact files:</strong></div>';
        Array.from(contactFiles).forEach(f => {
          html += `<div class="file-list-item">‚Ä¢ ${f.name}</div>`;
        });
      }
      if (countyFile){
        html += '<div class="file-list-item"><strong>Counties file:</strong></div>';
        html += `<div class="file-list-item">‚Ä¢ ${countyFile.name}</div>`;
      }
      if (html){
        fileList.style.display = 'block';
        fileListContent.innerHTML = html;
      } else {
        fileList.style.display = 'none';
      }
    }

    // ==================== HELPERS ====================
    const LAT_KEYS = ['latitude','lat','y','seatlat','geom_lat','lat_dd'];
    const LON_KEYS = ['longitude','long','lon','lng','x','seatlong','geom_lon','lon_dd'];

    function findField(obj, keys){
      for (const k of Object.keys(obj)){
        const low = k.toLowerCase();
        if (keys.includes(low)) return obj[k];
        // heuristic: contains "lat" or "lon"/"long"/"lng"
        if (keys.includes('latitude') && low.includes('lat')) return obj[k];
        if (keys.includes('longitude') && (low.includes('lon') || low.includes('long') || low.includes('lng'))) return obj[k];
      }
      return undefined;
    }

    function toNumber(v){
      const num = typeof v === 'string' ? parseFloat(v.trim()) : Number(v);
      return Number.isFinite(num) ? num : undefined;
    }

    function getContactType(row, fileName){
      const explicit = row.Contact_Type || row.contact_type || row.Type || row.type;
      if (explicit) return String(explicit).trim();
      const fn = (fileName || '').toLowerCase();
      if (fn.includes('broker')) return 'Brokers';
      if (fn.includes('survey')) return 'Surveyors';
      if (fn.includes('clear') || fn.includes('grade')) return 'Cleared/Graded';
      if (fn.includes('soil') || fn.includes('scientist')) return 'Soil Scientists';
      if (fn.includes('contractor')) return 'Contractors';
      return 'Other';
    }

    function safeJoin(a,b){ return [a,b].filter(Boolean).join(', '); }

    function processCSVRow(row, fileName){
      const latRaw = findField(row, LAT_KEYS);
      const lonRaw = findField(row, LON_KEYS);
      const lat = toNumber(latRaw);
      const lng = toNumber(lonRaw);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;

      const phone = row.Phone_Number___Mobile || row.Phone_Number___Work || row.Phone_Number___Main || row.Phone || row.phone || '';
      const email = row.Email_Address___Work || row.Email_Address___Home || row.Email || row.email || '';
      const website = row.Website || row.website || '';
      const county = row.County_Name || row.County || row.COUNTYNAME || row.county || '';
      const state  = row.State || row.Address___State || row.STATENAME || row.state || '';

      const first = row.First_Name || row.first_name || row.First || '';
      const last  = row.Last_Name || row.last_name || row.Last || '';
      const full  = row.Full_Name || row.full_name || `${(first||'')} ${(last||'')}`.trim() || 'Unknown';

      return {
        type:'Feature',
        geometry:{ type:'Point', coordinates:[lng,lat] },
        properties:{
          Full_Name: full,
          Phone: phone,
          Email: email,
          Website: website,
          County: county,
          State: state,
          Contact_Type: getContactType(row, fileName),
          Company: row.Company_Name || row.Organization || row.company || '',
          Job_Title: row.Job_Title || row.title || '',
          Address: row.Address___Address || row.address || '',
          City: row.Address___City || row.city || '',
          Notes: row.Notes || row.notes || '',
          Additional_Contacts: row.Additional_Contacts || '',
          Counties_Service: row.Counties_they_Service || row.service_counties || ''
        }
      };
    }

    function createCustomMarker(feature){
      const color = typeColors[feature.properties.Contact_Type] || '#808080';
      const html = `<div style="background-color:${color};width:24px;height:24px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.3);"></div>`;
      return L.divIcon({ html, className:'custom-marker', iconSize:[24,24], iconAnchor:[12,12], popupAnchor:[0,-12] });
    }

    function createPopupContent(p){
      let html = `<div class="info-popup">`;
      html += `<h4>${p.Full_Name || 'Unknown'}</h4>`;
      if (p.Contact_Type) html += `<p><strong>Type:</strong> ${p.Contact_Type}</p>`;
      if (p.Company) html += `<p><strong>Company:</strong> ${p.Company}</p>`;
      if (p.Job_Title) html += `<p><strong>Title:</strong> ${p.Job_Title}</p>`;
      if (p.Phone) html += `<p><strong>Phone:</strong> ${p.Phone}</p>`;
      if (p.Email) html += `<p><strong>Email:</strong> <a href="mailto:${p.Email}">${p.Email}</a></p>`;
      if (p.Website){
        const url = p.Website.startsWith('http') ? p.Website : `http://${p.Website}`;
        html += `<p><strong>Website:</strong> <a href="${url}" target="_blank" rel="noopener">${p.Website}</a></p>`;
      }
      const addr = safeJoin(p.Address, p.City);
      if (addr) html += `<p><strong>Address:</strong> ${addr}</p>`;
      if (p.County || p.State) html += `<p><strong>Location:</strong> ${safeJoin(p.County, p.State)}</p>`;
      if (p.Counties_Service) html += `<p><strong>Service Area:</strong> ${p.Counties_Service}</p>`;
      if (p.Notes) html += `<p><strong>Notes:</strong> ${p.Notes}</p>`;
      html += `</div>`;
      return html;
    }

    function createLegend(types){
      const wrap = document.getElementById('legendContent');
      wrap.innerHTML = '';
      types.forEach(type => {
        const color = typeColors[type] || '#808080';
        const count = typeStats[type] || 0;
        const safeId = `type_${type.replace(/[^\w]/g,'_')}`;
        const div = document.createElement('div');
        div.className = 'legend-item';
        div.innerHTML = `
          <input type="checkbox" id="${safeId}" checked>
          <div class="legend-color" style="background-color:${color}"></div>
          <label for="${safeId}">${type} (${count})</label>
        `;
        div.querySelector('input').addEventListener('change', (e)=>{
          if (e.target.checked) visibleTypes.add(type);
          else visibleTypes.delete(type);
          updateMarkers();
        });
        wrap.appendChild(div);
      });
    }

    function updateStatsPanel(){
      const panel = document.getElementById('statsPanel');
      const content = document.getElementById('statsContent');
      if (!Object.keys(typeStats).length) { panel.style.display = 'none'; return; }
      panel.style.display = 'block';
      let html = '';
      Object.entries(typeStats).sort(([a],[b]) => a.localeCompare(b)).forEach(([type,count]) => {
        html += `<div class="stats-item"><span>${type}:</span><strong>${count}</strong></div>`;
      });
      html += `<div class="stats-item" style="border-top:1px solid #eee;padding-top:8px;margin-top:8px;">
        <span>Total:</span><strong>${contactsData.length}</strong></div>`;
      content.innerHTML = html;
    }

    function updateMarkers(){
      markerCluster.clearLayers();
      allMarkers = [];

      const nameSearch = (document.getElementById('nameSearch').value || '').toLowerCase().trim();
      const countyFilter = document.getElementById('countySelect').value;
      const typeFilterVal = document.getElementById('typeFilter').value;
      const typeFilter = typeFilterVal ? typeFilterVal.split(' (')[0] : '';

      let visibleCount = 0;

      contactsData.forEach(f => {
        const p = f.properties;
        if (!visibleTypes.has(p.Contact_Type)) return;
        if (nameSearch && !(p.Full_Name||'').toLowerCase().includes(nameSearch)) return;
        if (countyFilter && p.County !== countyFilter) return;
        if (typeFilter && p.Contact_Type !== typeFilter) return;

        const [lng,lat] = f.geometry.coordinates;
        const marker = L.marker([lat,lng], { icon:createCustomMarker(f) });
        marker.bindPopup(createPopupContent(p));
        allMarkers.push(marker);
        visibleCount++;
      });

      markerCluster.addLayers(allMarkers);
      document.getElementById('resultCount').textContent = `Showing ${visibleCount} of ${contactsData.length} contacts`;
    }

    function populateFilters(){
      const counties = new Set();
      const types = new Set();
      typeStats = {};

      contactsData.forEach(f => {
        const p = f.properties;
        if (p.County) counties.add(p.County);
        if (p.Contact_Type){
          types.add(p.Contact_Type);
          typeStats[p.Contact_Type] = (typeStats[p.Contact_Type]||0)+1;
        }
      });

      // County select
      const countySel = document.getElementById('countySelect');
      countySel.innerHTML = '<option value="">All Counties</option>';
      Array.from(counties).sort().forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        countySel.appendChild(opt);
      });

      // Type select
      const typeSel = document.getElementById('typeFilter');
      typeSel.innerHTML = '<option value="">All Types</option>';
      visibleTypes.clear();
      Array.from(types).sort().forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = `${t} (${typeStats[t]})`;
        typeSel.appendChild(opt);
        visibleTypes.add(t);
      });

      createLegend(Array.from(types).sort());
      updateStatsPanel();
    }

    function clearFilters(){
      document.getElementById('nameSearch').value = '';
      document.getElementById('countySelect').value = '';
      document.getElementById('typeFilter').value = '';
      // Reset visible types to ALL
      visibleTypes = new Set(Object.keys(typeStats));
      // Reset legend checkboxes
      document.querySelectorAll('.legend-item input').forEach(cb => cb.checked = true);
      updateMarkers();
    }

    function zoomToFit(){
      if (allMarkers.length){
        const group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }

    // ==================== LOAD FLOW ====================
    document.getElementById('btnClear').addEventListener('click', clearFilters);
    document.getElementById('btnFit').addEventListener('click', zoomToFit);
    document.getElementById('nameSearch').addEventListener('input', updateMarkers);
    document.getElementById('countySelect').addEventListener('change', updateMarkers);
    document.getElementById('typeFilter').addEventListener('change', updateMarkers);

    document.getElementById('loadLocalFiles').addEventListener('click', async () => {
      const overlay = document.getElementById('loadingOverlay');
      const picker = document.getElementById('fileUploadContainer');
      const contactFiles = contactsInput.files;
      if (!contactFiles.length){ alert('Please select at least one contact CSV file'); return; }

      picker.style.display = 'none';
      overlay.style.display = 'flex';
      try{
        let allFeatures = [];
        for (const file of contactFiles){
          const text = await file.text();
          const result = Papa.parse(text, { header:true, dynamicTyping:true, skipEmptyLines:true });
          if (result.data && result.data.length){
            console.log(`Processing ${file.name}: ${result.data.length} rows`);
            result.data.forEach(row => {
              const feat = processCSVRow(row, file.name);
              if (feat) allFeatures.push(feat);
            });
          }
        }
        console.log(`Total features processed: ${allFeatures.length}`);

        if (!allFeatures.length){
          alert('No valid rows with latitude/longitude were found.');
          picker.style.display = 'block';
          return;
        }

        contactsData = allFeatures;
        populateFilters();
        updateMarkers();
        setTimeout(zoomToFit, 250);
      } catch(e){
        console.error('Error loading files:', e);
        alert('Error loading files. Please confirm the CSV structure.');
        document.getElementById('fileUploadContainer').style.display = 'block';
      } finally {
        overlay.style.display = 'none';
      }
    });
  </script>
</body>
</html>
